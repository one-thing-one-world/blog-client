kind: pipeline
type: docker
name: default
clone:
  disable: true

steps:
  - name: clone-test
    image: alpine/git
    pull: if-not-exists # 如果在本地缓存中找不到图像，则仅拉取图像
    commands:
      - git config --global http.version HTTP/1.1
      - git clone https://github.com/one-thing-one-world/blog-client.git
      - git version

  - name: install && build
    image: node
    pull: always
    commands:
      - pwd
      - cd blog-client
      - pwd
      - yarn
      - yarn  add react-scripts
      - yarn build:prod
      - ls
      - pwd

  - name: sshs
    image: appleboy/drone-ssh
    pull: always
    settings:
      host: 101.37.83.146
      username:
        from_secret: docker_username
      port: 22
      password:
        from_secret: docker_password
      script:
        - cd /usr/share/nginx/blog.cn/blog-client
        - rm -rf  build
        - echo 'delete build success ==='
        - echo
        - ls
        - pwd

  - name: upload
    image: appleboy/drone-scp
    pull: always
    settings:
      debug: true
      source:
        - blog-client/build/
      host: 101.37.83.146
      username:
        from_secret: docker_username
      port: 22
      password:
        from_secret: docker_password
      target: /usr/share/nginx/blog.cn/
      when:
        branch:
          include:
            - master
        event:
          - push
          - merge
      script:
        - nginx -s reload
        - cd /usr/share/nginx/blog.cn/
        - ls
        - pwd
        - echo upload success ===

trigger:
  branch:
    include:
      - master
  event:
    include:
      - push
